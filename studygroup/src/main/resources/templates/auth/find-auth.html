<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ID/PW 찾기 - STUDY MATE</title>
    <link rel="stylesheet" th:href="@{/css/signup.css}">
    <style>
        /* 1. 전체 레이아웃 및 탭 설정 */
        .tab-menu { display: flex; margin-bottom: 25px; border-bottom: 2px solid #eee; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; cursor: pointer; font-size: 1.05rem; color: #888; font-weight: 600; transition: all 0.3s; }
        .tab-btn.active { border-bottom: 3px solid #2b56f5; color: #2b56f5; }

        .find-section { display: none; }
        .find-section.active { display: block; }

        /* 2. 모든 입력창과 버튼 높이/간격 통일 */
        .find-section input, .input-group, .pw-name-group { margin-bottom: 15px !important; }
        .find-section input, .btn-small-action { height: 50px !important; box-sizing: border-box; }

        /* 3. 입력 그룹 설정 */
        .input-group { display: flex; gap: 8px; align-items: center; }
        .input-group input { margin-bottom: 0 !important; }
        .pw-name-group { display: flex; gap: 8px; }
        .pw-name-group input { flex: 1; margin-bottom: 0 !important; }

        .btn-small-action { padding: 0 20px; background-color: #f0f2ff; color: #2b56f5; border: 1px solid #2b56f5; border-radius: 4px; cursor: pointer; font-weight: 600; white-space: nowrap; }
        .btn-small-action:hover { background-color: #2b56f5; color: white; }

        /* 4. 결과 박스 및 버튼 스타일 */
        .result-box { background: #f8f9fa; padding: 25px; border-radius: 8px; margin-top: 20px; text-align: center; border: 1px solid #eee; }
        .result-text { font-size: 1.1rem; color: #333; margin-bottom: 20px; }
        .accent { color: #2b56f5; font-weight: bold; }

        /* 메인 버튼 (로그인 하러가기) */
        .login-move-btn {
            text-decoration: none;
            display: block;
            width: 100%;
            height: 60px;
            line-height: 60px;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 0;
            margin-top: 20px;
            background-color: #2b56f5;
            text-align: center;
            border-radius: 4px;
            color: white;
            box-sizing: border-box;
        }

        /* 보조 버튼 (비밀번호 찾기 - 새로 추가) */
        .sub-action-btn {
            text-decoration: none;
            display: block;
            width: 100%;
            height: 50px;
            line-height: 48px;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 10px;
            background-color: #fff;
            color: #888;
            text-align: center;
            border-radius: 4px;
            border: 1px solid #ddd;
            cursor: pointer;
            box-sizing: border-box;
        }
        .sub-action-btn:hover { background-color: #f9f9f9; color: #2b56f5; border-color: #2b56f5; }
    </style>
</head>
<body>

<div class="signup-container">
    <div class="header-box">
        <a th:href="@{/}" class="logo-text">STUDY MATE</a>
        <h2 class="title-text" style="margin-top: 10px;">ID/PW 찾기</h2>
    </div>

    <div class="tab-menu">
        <button class="tab-btn active" onclick="showTab('id')">ID 찾기</button>
        <button class="tab-btn" onclick="showTab('pw')">PW 찾기</button>
    </div>

    <div id="find-id-section" class="find-section active">
        <form onsubmit="return false;">
            <input type="text" id="idName" placeholder="이름" required class="signup-input">
            <div class="input-group">
                <input type="email" id="idEmail" placeholder="이메일 (인증필요)" required style="flex:1;">
                <button type="button" onclick="sendCode('id')" class="btn-small-action">인증번호 발송</button>
            </div>
            <div class="input-group">
                <input type="text" id="idAuthCode" placeholder="인증번호 입력" style="flex:1;">
                <button type="button" onclick="verifyCode('id')" class="btn-small-action">확인</button>
            </div>
            <button type="button" id="btnShowId" onclick="handleFindId()" class="submit-btn" disabled style="background-color:#ccc; margin-top: 5px;">아이디 확인</button>
        </form>

        <div id="idResult" class="result-box" style="display: none;">
            <p id="idText" class="result-text"></p>
            <a th:href="@{/login}" class="login-move-btn">로그인 하러가기</a>
            <button type="button" onclick="showTab('pw')" class="sub-action-btn">비밀번호 찾기</button>
        </div>
    </div>

    <div id="find-pw-section" class="find-section">
        <div id="pw-step1">
            <form onsubmit="return false;">
                <div class="pw-name-group">
                    <input type="text" id="pwUsername" placeholder="아이디" required>
                    <input type="text" id="pwName" placeholder="이름" required>
                </div>
                <div class="input-group">
                    <input type="email" id="pwEmail" placeholder="이메일 (인증필요)" required style="flex:1;">
                    <button type="button" onclick="sendCode('pw')" class="btn-small-action">인증번호 발송</button>
                </div>
                <div class="input-group">
                    <input type="text" id="pwAuthCode" placeholder="인증번호 입력" style="flex:1;">
                    <button type="button" onclick="verifyCode('pw')" class="btn-small-action">확인</button>
                </div>
            </form>
        </div>

        <div id="pw-step2" style="display: none; margin-top: 20px;">
            <p style="color:#2b56f5; font-weight:bold; margin-bottom:15px;">✅ 인증되었습니다. 새로운 비밀번호를 설정해주세요.</p>
            <form onsubmit="return false;">
                <input type="password" id="newPw" placeholder="새로운 비밀번호" required>
                <input type="password" id="newPwConfirm" placeholder="새로운 비밀번호 확인" required>
                <button type="button" onclick="handleResetPw()" class="submit-btn" style="margin-top: 5px;">비밀번호 변경</button>
            </form>
        </div>

        <div id="pwResult" class="result-box" style="display: none;">
            <p class="result-text"><span class="accent">비밀번호가 성공적으로 변경되었습니다.</span><br>새로운 비밀번호로 로그인해주세요.</p>
            <a th:href="@{/login}" class="login-move-btn">로그인 하러가기</a>
        </div>
    </div>
</div>

<script>
    function showTab(type) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.find-section').forEach(section => section.classList.remove('active'));

        // 탭 전환 시 기존 결과창들은 숨겨줍니다 (UI 초기화)
        document.getElementById('idResult').style.display = 'none';
        document.getElementById('pwResult').style.display = 'none';

        if(type === 'id') {
            document.querySelector('.tab-btn:first-child').classList.add('active');
            document.getElementById('find-id-section').classList.add('active');
        } else {
            document.querySelector('.tab-btn:last-child').classList.add('active');
            document.getElementById('find-pw-section').classList.add('active');
        }
    }

    let isIdVerified = false;
    let isPwVerified = false;

    function sendCode(type) {
        const emailId = type === 'id' ? 'idEmail' : 'pwEmail';
        const email = document.getElementById(emailId).value;
        const name = type === 'id' ? document.getElementById('idName').value : document.getElementById('pwName').value;
        const username = type === 'pw' ? document.getElementById('pwUsername').value : '';

        if(!email || !name) return alert("이름과 이메일을 모두 입력해주세요.");
        if(type === 'pw' && !username) return alert("아이디를 입력해주세요.");

        fetch(`/mail/send?email=${email}&name=${name}&username=${username}&type=${type}`, { method: 'POST' })
            .then(res => res.text())
            .then(result => {
                if(result === 'success') alert("인증번호가 발송되었습니다.");
                else if(result === 'not_found') alert("일치하는 가입 정보가 없습니다.");
                else alert("발송 실패. 다시 시도해주세요.");
            });
    }

    function verifyCode(type) {
        const codeId = type === 'id' ? 'idAuthCode' : 'pwAuthCode';
        const code = document.getElementById(codeId).value;
        fetch(`/mail/verify?code=${code}`, { method: 'POST' })
            .then(res => res.json())
            .then(ok => {
                if(ok) {
                    alert("인증 성공!");
                    if(type === 'id') {
                        isIdVerified = true;
                        document.getElementById('btnShowId').disabled = false;
                        document.getElementById('btnShowId').style.backgroundColor = "#2b56f5";
                    } else {
                        isPwVerified = true;
                        document.getElementById('pw-step1').style.display = 'none';
                        document.getElementById('pw-step2').style.display = 'block';
                    }
                } else alert("인증번호가 틀렸습니다.");
            });
    }

    function handleFindId() {
        if(!isIdVerified) return alert("먼저 이메일 인증을 완료해주세요.");
        const name = document.getElementById('idName').value;
        const email = document.getElementById('idEmail').value;
        fetch(`/find-id?name=${name}&email=${email}`, { method: 'POST' })
            .then(res => res.text())
            .then(data => {
                if(data === 'not_found') alert("일치하는 가입 정보가 없습니다.");
                else {
                    document.getElementById('idResult').style.display = 'block';
                    document.getElementById('idText').innerHTML = `회원님의 아이디는 <span class="accent">${data}</span> 입니다.`;
                }
            });
    }

    function handleResetPw() {
        if(!isPwVerified) return alert("잘못된 접근입니다.");
        const username = document.getElementById('pwUsername').value;
        const newPw = document.getElementById('newPw').value;
        const newPwConfirm = document.getElementById('newPwConfirm').value;

        if(newPw !== newPwConfirm) return alert("새로운 비밀번호가 일치하지 않습니다.");

        fetch('/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `username=${username}&newPassword=${newPw}`
        })
        .then(res => res.text())
        .then(data => {
            if(data === 'success') {
                document.getElementById('pw-step2').style.display = 'none';
                document.getElementById('pwResult').style.display = 'block';
            } else if(data === 'same_password') alert("이전과 비밀번호가 같습니다. 새로운 비밀번호를 설정해주세요.");
            else alert("가입 정보가 없습니다. 아이디를 확인해주세요.");
        });
    }
</script>
</body>
</html>