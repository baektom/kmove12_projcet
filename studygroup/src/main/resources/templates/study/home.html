<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>STUDY MATE - í™ˆ</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        .search-container { display: flex; justify-content: center; margin: 40px 0; }
        .search-form { display: flex; max-width: 600px; width: 100%; gap: 10px; }
        .search-input { flex-grow: 1; padding: 12px 20px; background-color: #f8f9fa; border: 2px solid #e9ecef; border-radius: 30px; font-size: 1rem; outline: none; text-align: center; }
        .search-btn { padding: 12px 30px; background-color: #2b56f5; color: white; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .search-btn:hover { background-color: #1a3ebf; }
        .create-study-btn { display: inline-block; padding: 12px 30px; background-color: #28a745; color: white; border: none; border-radius: 30px; font-weight: bold; text-decoration: none; cursor: pointer; transition: background-color 0.2s; margin-bottom: 20px; }
        .create-study-btn:hover { background-color: #218838; }
        .study-grid { display: flex; gap: 20px; margin-bottom: 40px; }
        .study-card { background-color: #eee; padding: 30px; flex: 1; border-radius: 8px; text-align: center; font-weight: bold; }
        .study-item { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background-color 0.2s; }
        .study-item:hover { background-color: #f8f9fa; }
        .study-title { font-size: 1.1rem; font-weight: 500; text-decoration: none; color: #333; }
        .study-title:hover { color: #2b56f5; }
        .study-info { display: flex; align-items: center; gap: 15px; color: #666; font-size: 0.9rem; }
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; }
        .status-recruiting { background-color: #d4edda; color: #155724; }
        .status-closed { background-color: #f8d7da; color: #721c24; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    </style>
</head>
<body>

<header th:replace="~{layout/header :: header}"></header>

<main class="container" style="max-width: 1000px; margin: 0 auto; padding: 20px;">
    <div class="main-visual" style="text-align: center; padding: 40px 0;">
        <img th:src="@{/img/globe_icon.png}" alt="logo" style="width: 300px;">
    </div>

    <div class="search-container">
        <form th:action="@{/studies}" method="get" class="search-form">
            <input type="text" name="q" class="search-input" placeholder="ê´€ì‹¬ìˆëŠ” ìŠ¤í„°ë””ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”!" th:value="${q}">
            <button type="submit" class="search-btn">ê²€ìƒ‰</button>
        </form>
    </div>

    <hr style="border: 0; border-top: 1px solid #eee; margin: 40px 0;">

    <section class="study-section">
        <div style="display:flex; gap:30px; align-items:flex-start;">
            <div style="flex:1;">
                <h3 style="margin:0 0 20px 0;">ì£¼ëª©ë°›ëŠ” ìŠ¤í„°ë””ë£¸ (ì¡°íšŒìˆ˜)</h3>
                <div th:if="${#lists.isEmpty(featuredStudies)}" style="padding:20px; color:#999;">ì•„ì§ ì£¼ëª©ë°›ëŠ” ìŠ¤í„°ë””ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                <div th:each="study : ${featuredStudies}" class="study-item" th:onclick="|location.href='@{/study/{id}(id=${study.id})}'|" style="border:1px solid #eee; border-radius:10px; margin-bottom:12px; padding:16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <a th:href="@{/study/{id}(id=${study.id})}" th:text="${study.title}" class="study-title">ì œëª©</a>
                        <span style="color:#666; font-size:0.9rem;">ì¡°íšŒìˆ˜ <b th:text="${study.viewCount}">0</b></span>
                    </div>
                </div>
                <div style="margin-top:18px;">
                    <h4 style="margin:0 0 10px 0; color:#333;">í‚¤ì›Œë“œ</h4>
                    <div style="display:flex; flex-wrap:wrap; gap:10px;">
                        <a th:each="k : ${keywordList}" th:href="@{/studies(keywordId=${k.id})}" th:text="${k.name}" style="padding:8px 14px; border-radius:20px; background:#f1f3f5; text-decoration:none; color:#333; font-weight:600;"></a>
                    </div>
                </div>
            </div>

            <div style="flex:1;">
                <div class="section-header">
                    <a th:href="@{/studies}" style="border-bottom: 2px solid #2b56f5; display:inline-block; margin:0; font-size:1.2rem; font-weight:700; text-decoration:none; color:#333;">ì „ì²´ ë³´ê¸°</a>
                </div>
                <div class="study-list" style="margin-top: 10px;">
                    <div th:each="study : ${previewStudies}" class="study-item" th:onclick="|location.href='@{/study/{id}(id=${study.id})}'|">
                        <a th:href="@{/study/{id}(id=${study.id})}" th:text="${study.title}" class="study-title">ìŠ¤í„°ë”” ì œëª©</a>
                        <div class="study-info">
                            <span class="status-badge" th:classappend="${study.status == 'ëª¨ì§‘ì¤‘'} ? 'status-recruiting' : 'status-closed'" th:text="${study.status}">ëª¨ì§‘ì¤‘</span>
                            <span>ì°¸ì—¬ì¸ì› <span th:text="${study.currentParticipants}" style="color:#2b56f5; font-weight:bold;">0</span> / <span th:text="${study.maxParticipants}">5</span></span>
                            <span style="color:#666;">ì¡°íšŒìˆ˜ <b th:text="${study.viewCount}">0</b></span>
                        </div>
                    </div>
                    <div th:if="${#lists.isEmpty(previewStudies)}" style="padding: 50px; text-align: center; color: #999;">ì•„ì§ ë“±ë¡ëœ ìŠ¤í„°ë””ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>
    </section>
</main>

<input type="hidden" id="userId" th:value="${session.loginUserId != null ? session.loginUserId : 'ìµëª…'}">
<input type="hidden" id="userNameDisplay" th:value="${session.loginUserName != null ? session.loginUserName : 'ìµëª…'}">

<div id="chat-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000; font-family: sans-serif;">
    <div id="chat-window" style="display: none; width: 300px; height: 400px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); flex-direction: column; overflow: hidden; margin-bottom: 10px; border: 1px solid #eee;">
        <div style="background: #2b56f5; color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between;">
            <span>ì „ì²´ ì±„íŒ…ë°©</span>
            <button onclick="toggleChat()" style="background: none; border: none; color: white; cursor: pointer;">X</button>
        </div>
        <div id="chat-messages" style="flex: 1; padding: 15px; overflow-y: auto; font-size: 0.9rem;">
        </div>
        <div style="padding: 10px; border-top: 1px solid #eee; display: flex; gap: 5px;">
            <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." style="flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 8px 12px; outline: none;">
            <button onclick="sendMessage()" style="background: #2b56f5; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer;">â–¶</button>
        </div>
    </div>
    <button onclick="toggleChat()" style="width: 60px; height: 60px; background: #2b56f5; border-radius: 50%; border: none; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; float: right;">
        <span style="font-size: 30px;">ğŸ’¬</span>
    </button>
</div>

<script>
    // 1. ì†Œì¼“ ì—°ê²° (í¬íŠ¸ 8087)
    const socket = new WebSocket("ws://localhost:8087/ws/chat");

    // [ì§„ë‹¨] ì—°ê²° ì„±ê³µ ì‹œ ì½˜ì†”ì— ë©”ì‹œì§€ í‘œì‹œ
    socket.onopen = function() {
        console.log("âœ… ì±„íŒ… ì„œë²„ì™€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!");
    };

    // [ì§„ë‹¨] ì—°ê²° ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ì°½ ë„ìš°ê¸°
    socket.onerror = function() {
        alert("âŒ ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. IntelliJ ì„œë²„ê°€ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”!");
    };

    const chatWindow = document.getElementById('chat-window');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const userIdInput = document.getElementById('userId');
    const userNameDisplayInput = document.getElementById('userNameDisplay');

    function toggleChat() {
        chatWindow.style.display = chatWindow.style.display === 'none' ? 'flex' : 'none';
    }

    socket.onmessage = function(event) {
        const parts = event.data.split(" : ");
        const senderName = parts[0];
        const text = parts[1] || parts[0];
        const myId = userIdInput.value === "ìµëª…" ? "1" : userIdInput.value;

        if (senderName !== myId && senderName !== "ë‚˜") {
            displayMessage(senderName, text, "left");
        }
    };

    function sendMessage() {
        const myId = userIdInput.value === "ìµëª…" ? "1" : userIdInput.value;
        let myRealName = userNameDisplayInput.value;
        if (myRealName === "ìµëª…" || !myRealName) {
            myRealName = "no name";
        }

        const message = chatInput.value.trim();

        // [í•µì‹¬] ì†Œì¼“ì´ ì—´ë ¤ìˆì„ ë•Œë§Œ ë³´ëƒ…ë‹ˆë‹¤
        if (message !== "" && socket.readyState === WebSocket.OPEN) {
            socket.send(myId + " : " + message);
            displayMessage("ë‚˜", message, "right");
            chatInput.value = "";
        } else if (socket.readyState !== WebSocket.OPEN) {
            alert("ì—°ê²° ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
        }
    }

    function displayMessage(user, text, align) {
        const msgDiv = document.createElement('div');
        const isRight = align === "right";
        msgDiv.style.cssText = `
            margin-bottom: 10px; padding: 8px 12px;
            background: ${isRight ? '#2b56f5' : '#f1f3f5'};
            color: ${isRight ? 'white' : '#333'};
            border-radius: 12px; width: fit-content;
            max-width: 80%; margin-left: ${isRight ? 'auto' : '0'};
        `;
        msgDiv.innerHTML = `<span style="display:block; font-size:10px; margin-bottom:4px; opacity:0.8;">${user}</span>` + text;
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    chatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
</script>

</body>
</html>